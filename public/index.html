<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Planny (HTML)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* === Stili base (lascia la tua UI invariata) === */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:#111; background:#f7f7f9; }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
    .wrap { max-width:1100px; margin:0 auto; padding:16px 20px; }
    h1 { margin:0; font-size:20px; display:flex; align-items:center; gap:10px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar input[type="number"]{ width:90px; padding:6px 8px; border:1px solid #cfd6df; border-radius:8px; }
    .toolbar button{ padding:6px 10px; border:1px solid #cfd6df; border-radius:8px; background:#fff; cursor:pointer }
    textarea#terminal{ width:100%; height:150px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; }
    /* Indicatore salvataggio */
    #save-indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#5b6877;user-select:none}
    #save-indicator .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#aaa}
    #save-indicator .dot.ok{background:#16a34a}
    #save-indicator .dot.dirty{background:#e11d48}
    #save-indicator .dot.wait{background:#f59e0b;animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
    /* Calendario (placeholder: la tua UI reale vive sotto) */
    #calendar{ min-height: 300px; }
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <div class="row">
        <h1>
          Planny (HTML)
          <span id="save-indicator" title="Stato salvataggio">
            <span class="dot"></span><span class="label">pronto</span>
          </span>
        </h1>
        <div class="toolbar">
          <label>Anno
            <input id="year" type="number" min="2000" max="2100" step="1" />
          </label>
          <!-- RIMOSSO: pulsante Esporta Excel -->
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- La tua UI del calendario resta invariata; qui un contenitore -->
    <section id="calendar" class="card"></section>

    <section class="card" style="margin-top:12px;">
      <h3 style="margin-top:0">Terminale</h3>
      <textarea id="terminal" placeholder="Log azioni…"></textarea>
    </section>
  </main>

  <!-- ========== LE TUE FUNZIONI ESISTENTI ==========
       Se hai file JS esterni, includili qui
       <script src="/js/tuo_file.js"></script>
       Devono definire:
         - importSelectionsFromText(text)
         - renderCalendar()
         - writeCell(td, value)
         - selectionsToText()
  ================================================ -->

  <!-- === CLOUD I/O PATCH: niente download, solo API JSON === -->
  <script>
  (function(){
    const KEY_RX = /(^|\/)(config\.ini|config\.txt|selections_\d{4}\.txt|festivi_\d{4}\.txt)$/i;
    const _origFetch = window.fetch.bind(window);

    // Lettura dal server (JSON → text) con fallback legacy
    async function cloudRead(name){
      try{
        const r = await _origFetch('/api/files/text/' + encodeURIComponent(name) + '?' + Date.now(), {cache:'no-store'});
        if (r.ok){
          const j = await r.json().catch(()=>({ok:false}));
          if (j && j.ok) return j.text || '';
        }
      }catch(_){}
      try{
        const r2 = await _origFetch('/api/files/' + encodeURIComponent(name) + '?' + Date.now(), {cache:'no-store'});
        if (r2.ok) return await r2.text();
      }catch(_){}
      return '';
    }
    // Scrittura sul server (JSON)
    async function cloudWrite(name, content){
      const r = await _origFetch('/api/files/text/' + encodeURIComponent(name), {
        method:'PUT', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: content || ''
      });
      const j = await r.json().catch(()=>({ok:false}));
      if(!r.ok || !j.ok) throw new Error('HTTP '+r.status);
      return j;
    }

    // Helper globali usati dalla tua app
    window.getTextFromServer = async (name)=> cloudRead(name);
    window.putTextToServer  = async (name,content)=> cloudWrite(name,content);

    // Se la tua app usa fetchText(name), forziamo il passaggio dal cloud per i file chiave
    const _origFetchText = typeof window.fetchText === 'function' ? window.fetchText.bind(window) : null;
    window.fetchText = async function(name){
      if (KEY_RX.test(String(name))) return await cloudRead(name);
      return _origFetchText ? await _origFetchText(name) : '';
    };

    // Impedisci QUALSIASI click che aprirebbe i file chiave in una nuova scheda (download)
    document.addEventListener('click', function(ev){
      const a = ev.target.closest && ev.target.closest('a[href]');
      if(!a) return;
      const href = a.getAttribute('href') || '';
      if (KEY_RX.test(href)) {
        ev.preventDefault();
        ev.stopPropagation();
        const term = document.getElementById('terminal');
        if (term) { term.value += '\n[info] Bloccato download di ' + href; term.scrollTop = term.scrollHeight; }
        return false;
      }
    }, true);
  })();
  </script>
  <!-- === /CLOUD I/O PATCH === -->

  <!-- === INDICATORE DI SALVATAGGIO + BLOCCO REFRESH === -->
  <script>
  (function(){
    let __dirty=false, __saving=false, __saveTimer=null;

    function updateSaveIndicator(){
      const el=document.getElementById('save-indicator'); if(!el) return;
      const dot=el.querySelector('.dot'), lab=el.querySelector('.label');
      if(__saving){ dot.className='dot wait'; lab.textContent='salvataggio…'; return; }
      if(__dirty){ dot.className='dot dirty'; lab.textContent='non salvato'; }
      else{ dot.className='dot ok'; lab.textContent='salvato'; }
    }
    function setDirty(v){ __dirty=!!v; updateSaveIndicator(); }
    function setSaving(v){ __saving=!!v; updateSaveIndicator(); }

    // Blocca refresh/chiusura se non salvato
    window.addEventListener('beforeunload',(e)=>{
      if(__dirty || __saving){ e.preventDefault(); e.returnValue=''; return ''; }
    });

    // Integra nel tuo flusso di editing
    if(typeof window.writeCell==='function'){
      const __origWriteCell = window.writeCell;
      window.writeCell = function(...args){
        const ret = __origWriteCell.apply(this,args);
        try{ setDirty(true); window.scheduleAutoSave(); }catch(_){}
        return ret;
      };
    }

    const __origSchedule = window.scheduleAutoSave;
    window.scheduleAutoSave = function(...args){
      setDirty(true);
      if(typeof __origSchedule==='function'){ return __origSchedule.apply(this,args); }
      clearTimeout(__saveTimer);
      __saveTimer=setTimeout(()=>{ try{ window.saveNow(); }catch(_){ } }, 800);
    };

    const __origSaveNow = window.saveNow;
    window.saveNow = async function(...args){
      setSaving(true);
      try{
        if(typeof __origSaveNow==='function'){
          const r = await __origSaveNow.apply(this,args);
          setDirty(false);
          return r;
        }else{
          // fallback se non hai un saveNow centralizzato
          if(typeof window.selectionsToText==='function'){
            const name = 'selections_' + (window.state && window.state.year ? window.state.year : new Date().getFullYear()) + '.txt';
            const text = window.selectionsToText();
            await window.putTextToServer(name, text);
          }
          setDirty(false);
        }
      }catch(e){
        console.warn('Errore saveNow:', e);
      }finally{
        setSaving(false);
      }
    };

    // Prime render: indicator default
    document.addEventListener('DOMContentLoaded', updateSaveIndicator);

    // Esponi per debug esterno
    window.__saveIndicator={ setDirty, setSaving, updateSaveIndicator };
  })();
  </script>
  <!-- === /INDICATORE DI SALVATAGGIO + BLOCCO REFRESH === -->

  <!-- === BOOT: carica selections_<anno>.txt e renderizza con le TUE funzioni === -->
  <script>
  (function(){
    function detectYear(){
      if (window.state && window.state.year) return +window.state.year;
      const sel = document.querySelector('#year');
      if (sel && sel.value) return +sel.value;
      const saved = +localStorage.getItem('plannyYear') || 0;
      const now = new Date().getFullYear();
      return saved || now;
    }
    async function loadAndRender(year){
      try{
        const txt = await window.getTextFromServer(`selections_${year}.txt`);
        if (typeof window.importSelectionsFromText === 'function') window.importSelectionsFromText(txt||'');
        if (typeof window.renderCalendar === 'function') window.renderCalendar();
      }catch(e){
        const term=document.getElementById('terminal');
        if(term){ term.value += '\n[errore] load '+year+': '+e; term.scrollTop=term.scrollHeight; }
      }
    }
    async function boot(){
      const y = detectYear();
      window.state = window.state || {}; window.state.year = y;
      const sel = document.getElementById('year');
      if (sel) { sel.value = String(y); sel.addEventListener('change', async ()=> {
        const v = parseInt(sel.value, 10);
        if (!Number.isNaN(v)) {
          window.state.year = v;
          localStorage.setItem('plannyYear', String(v));
          await loadAndRender(v);
        }
      }); }
      await loadAndRender(y);
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  })();
  </script>
  <!-- === /BOOT === -->

</body>
</html>
