<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planny HTML</title>

<style id="addon-terminal-minheight-v3">
  .card:first-of-type { display: none !important; }
  #terminal, .terminal, #console, .console, #log, .log {
    height: 140px !important;
    max-height: 140px !important;
    overflow-y: auto !important;
  }
  .ln.ln-cell{ background: transparent; padding: 0; margin: 2px 0; }
  .terminal .ln{ background: transparent !important; }
  .terminal .ln.ln-cell{ background: transparent !important; padding: 0; margin: 2px 0; }
  #calendar {table-layout: fixed; width:100%; border-collapse: collapse;}
  th.datecol, td.datecol {width:100px; min-width:100px; max-width:100px;}
  td, th {padding: 2px 4px;}
  #calendar-container {margin-left:0;margin-right:0;padding-left:4px;padding-right:4px;max-width:100%;}
  #calendar {margin-left:0;margin-right:0;}
  .wrap{max-width:100% !important;margin:0 !important;padding-left:6px !important;padding-right:6px !important;}
  .card{padding-left:8px !important;padding-right:8px !important;}
  .month{margin-top:8px;}
</style>

<style>
  :root{
    --bg:#f5f7fb; --panel:#ffffff; --surface:#eef2f7; --border:#dfe5ef;
    --text:#0f1720; --muted:#5b6877;
    --accent:#2563eb; --accent2:#16a34a; --warn:#d97706; --holiday:#166534;
    --chip:#f3f8ff; --chipBorder:#cfd9ea; --todayRow:rgba(34,197,94,18);
    --nameHeaderBg:#e9f3ff; --nameColBg:#f8fbff;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  h1{font-size:20px;margin:0 0 10px}
  .wrap{max-width:1280px;margin:0 auto;padding:16px}

  .bar{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;align-items:center}
  .bar label{display:block;font-size:12px;opacity:.7}
  .bar input{width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:#fff}
  .btn{padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}
  .btn:hover{background:#f8fafc}

  .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
  .month{display:grid;grid-template-columns:1fr}

  .terminal{
    background:#0b0b0b;border:1px solid var(--border);border-radius:14px;padding:10px;color:#c7d1db;
    font:12px/1.4 ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;height:220px;overflow-y:auto;overflow-x:hidden;word-break:break-word;
  }
  .ln{white-space:pre-wrap;margin:2px 0}
  .ln.info{color:#9bb0c9} .ln.ok{color:#16a34a} .ln.warn{color:#f59e0b} .ln.err{color:#ef4444}

  /* Context menu */
  .ctx{position:fixed; z-index:9999; background:#10151c; color:#e2e8f0; border:1px solid #2a3441; border-radius:10px; box-shadow:0 12px 28px rgba(0,0,0,.35); padding:6px; min-width:180px; display:none}
  .ctx .itm{padding:8px 10px; border-radius:8px; cursor:pointer; user-select:none}
  .ctx .itm:hover,ctx .itm:focus{background:#1b2532; outline:none}
  .ctx .sep{height:1px; background:#233042; margin:6px 4px}

  #calendar {table-layout: fixed; width:100%; border-collapse: collapse;}
  th.datecol, td.datecol {width:100px; min-width:100px; max-width:100px;}
  td, th {padding: 2px 4px;}
  .chip{display:inline-block;padding:4px 8px;border:1px solid var(--chipBorder);border-radius:999px;background:var(--chip)}
  .chip.hidden{display:none}
  .droptarget{outline:2px dashed var(--accent)}
  .count{font:12px monospace;opacity:.7}
  .count.ok{color:var(--accent2)}
  .count.warn{color:var(--warn)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Planny (HTML)</h1>

  <div class="card">
    <div class="bar">
      <div><label>Anno</label><input id="year" type="number" min="1900" max="2100" disabled /></div>
      <div><label>Nomi Team</label><input id="names" type="text" disabled /></div>
      <div><label>Opzioni</label><input id="options" type="text" disabled /></div>
      <div style="grid-column: span 5"></div>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <div id="tabs" style="display:flex;gap:6px;flex-wrap:wrap"></div>
    <div id="calendar-container" class="panel">
      <table id="calendar">
        <thead id="thead"></thead>
        <tbody id="month"></tbody>
      </table>
    </div>
    <div style="display:flex;gap:6px;align-items:center;margin-top:8px">
      <button id="jump-today" class="btn">Oggi</button>
      <span id="status"></span>
    </div>
  </div>

  <div class="card" style="margin-top:10px">
    <h2 style="margin:0 0 8px;font-size:14px;color:#9bb0c9">Terminale</h2>
    <div id="terminal" class="terminal" aria-live="polite" aria-atomic="false"></div>
  </div>
</div>

<!-- Context menu -->
<div id="ctx" class="ctx" role="menu" aria-hidden="true">
  <div class="itm" data-cmd="copy" tabindex="0">Copia</div>
  <div class="itm" data-cmd="paste" tabindex="0">Incolla</div>
  <div class="sep"></div>
  <div class="itm" data-cmd="clear" tabindex="0">Cancella</div>
</div>

<datalist id="options-list"></datalist>

<script>
(function(){
  /* ------- Logger ------- */
  const logBuffer = []; let logFlushCursor = 0;
  function log(msg, type='info'){
    (type==='err'?console.error:type==='warn'?console.warn:console.log)(msg);
    if(type !== 'cell') return;
    const t = document.getElementById('terminal');
    const ts = new Date().toLocaleTimeString();
    const text = '['+ts+'] '+msg;
    logBuffer.push(text);
    if(t){
      const line = document.createElement('div');
      line.className='ln ln-cell';
      line.textContent=text;
      t.appendChild(line);
      t.scrollTop = t.scrollHeight;
    }
  }
  function logAction(action, date, name, value, extra){
    const line = `${action} ${date}, ${name}${value!==undefined && value!==''?','+value:''}${extra? ' '+extra: ''}`;
    log(line,'cell');
  }
  window.addEventListener('error', ev=>log('JS error: '+ev.message,'err'));
  window.addEventListener('unhandledrejection', ev=>log('Promise: '+(ev.reason?.message||ev.reason),'err'));

  /* ------- Stato ------- */
  const state = {
    year: new Date().getFullYear(),
    names: [], options: [],
    selections: new Map(),
    columnOrder: null, holidays: new Set(),
    stackTop:null, stackBottom:null, stackCenter:null,
    anchorCell: null, selected: new Set(),
    clipboard: null,
    ctxTarget: null,
    search: {q:'', hits:[], idx:-1}
  };
  window.state = state; // export per altri script
  state.deletions = new Set();
  const save = { selName:'', logName:'' };

  const $=s=>document.querySelector(s);
  const months=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];
  const pad=n=>(n<10?"0":"")+n;
  const fmt=d=>pad(d.getDate())+"-"+pad(d.getMonth()+1)+"-"+d.getFullYear();
  const cssEscape = (s)=> (window.CSS && CSS.escape ? CSS.escape(s) : s.replace(/[^a-zA-Z0-9_-]/g, ch => '\\'+ch));

  /* ------- Suggestions (prefix-based) ------- */
  const suggest = {
    box: null, items: [], index: -1, input: null,
    open(input){
      this.close();
      this.input = input;
      this.box = document.createElement('div');
      this.box.className='panel';
      this.box.style.position='fixed';
      this.box.style.zIndex=9999;
      this.box.style.padding='6px';
      this.box.style.maxHeight='220px';
      this.box.style.overflowY='auto';
      document.body.appendChild(this.box);
      this.index=-1;
      this.update(); this.position();
    },
    close(){
      if(this.box){ this.box.remove(); this.box=null; }
      this.items=[]; this.index=-1; this.input=null;
    },
    position(){
      if(!this.box || !this.input) return;
      const r = this.input.getBoundingClientRect();
      this.box.style.left = Math.round(r.left) + 'px';
      this.box.style.top  = Math.round(r.bottom + 4) + 'px';
      this.box.style.minWidth = Math.max(140, Math.round(r.width)) + 'px';
    },
    update(){
      if(!this.input) return;
      const q = (this.input.value||'').trim().toLowerCase();
      if(!q){ this.items=[]; this.render(); return; }
      const opts = (state.options||[]).slice();
      const pref = opts.filter(o=> (o||'').toLowerCase().startsWith(q));
      this.items = pref.slice(0, 20);
      this.render();
    },
    render(){
      if(!this.box) return;
      this.box.innerHTML = this.items.map((t,i)=>`<div class="it${i===this.index?' active':''}" style="padding:8px 10px;border-radius:8px;cursor:pointer;white-space:nowrap">${t}</div>`).join('');
    },
    move(delta){
      if(!this.items.length){ this.index=-1; this.render(); return; }
      this.index = ( (this.index + delta) % this.items.length + this.items.length ) % this.items.length;
      this.render();
    },
    apply(idx=null){
      if(idx==null) idx=this.index;
      if(idx<0 || idx>=this.items.length || !this.input) return;
      const val = this.items[idx];
      this.input.value = val;
      const p=this.input.dataset.date.split('-'); const d=new Date(+p[2], +p[1]-1, +p[0]);
      styleCell(this.input, val, d);
      this.close();
      setTimeout(()=>{ this.input.focus(); this.input.selectionStart=this.input.selectionEnd=this.input.value.length; },0);
    }
  };
  window.addEventListener('resize', ()=> suggest.position());
  window.addEventListener('scroll', ()=> suggest.position(), true);

  /* ------- Helpers fetch/file ------- */
  async function fetchText(path){
    try{
      const r=await fetch(path,{cache:'no-cache'});
      if(!r.ok){ log(`fetchText ${path} -> HTTP ${r.status}`,'warn'); return null; }
      return await r.text();
    }catch(e){
      log(`fetchText ${path} errore: ${e.message}`,'warn');
      return null;
    }
  }
  async function fetchJSON(url){
    try{
      const r=await fetch(url,{cache:'no-cache'});
      if(!r.ok){ log(`fetchJSON ${url} -> HTTP ${r.status}`,'warn'); return null; }
      return await r.json();
    }catch(e){
      log(`fetchJSON ${url} errore: ${e.message}`,'warn');
      return null;
    }
  }
  async function putTextToServer(name, content){
    const r = await fetch(`/api/files/${encodeURIComponent(name)}`, {
      method:'PUT', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: content
    });
    if(!r.ok) throw new Error('PUT '+name+' → '+r.status);
    try{ return await r.json(); }catch{ return {ok:true}; }
  }
  async function getTextFromServer(name){
    const r = await fetch(`/api/files/${encodeURIComponent(name)}?ts=${Date.now()}`, {cache:'no-store'});
    if(r.status===404) return null;
    if(!r.ok) throw new Error('GET '+name+' → '+r.status);
    return await r.text();
  }
  async function appendLogsToServer(opts={}){
    const name = save.logName || ('planny_log_'+state.year+'.txt');
    const piece = (opts && opts.force) ? '' : (logBuffer.slice(logFlushCursor).join('\n')+'\n');
    logFlushCursor = logBuffer.length;
    try{
      await fetch(`/api/files/${encodeURIComponent(name)}`, { method:'PUT', body: piece });
      if(opts && opts.force) log('Log aggiornato (PUT) su server: '+name,'info');
    }catch(e){
      // non bloccare mai per i log
      console.warn('Log append fallito:', e);
    }
  }

  // ====== BEGIN: SAVE COALESCENTE (no race, no falsi mismatch) ======
  let __saveInFlight = false;
  let __saveQueued = false;
  let __saveTimer = null;

  function normSelectionsText(s){
    return String(s||'')
      .replace(/\r\n/g, '\n')
      .replace(/[ \t]+$/gm, '')
      .trim();
  }

  async function saveSelectionsToServer(){
    const name = selectionsFileName();
    if (__saveInFlight) { __saveQueued = true; return; }
    __saveInFlight = true;

    try{
      const textRaw = selectionsToText();
      const text = normSelectionsText(textRaw) + '\n';
      await putTextToServer(name, text);
      try{ localStorage.setItem('selections_'+state.year, text); }catch(_){}
      log('Selections salvati su server: '+name, 'ok');
    }catch(err){
      log('Server non disponibile per selections (download locale): '+(err && err.message || err),'warn');
      const text = selectionsToText();
      try{ localStorage.setItem('selections_'+state.year, text); }catch(_){}
      // fallback locale
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text],{type:'text/plain;charset=utf-8'}));
      a.download = selectionsFileName();
      a.click();
      URL.revokeObjectURL(a.href);
    }finally{
      __saveInFlight = false;
      if (__saveQueued) {
        __saveQueued = false;
        scheduleAutoSave(300);
      }
    }
  }

  async function saveNow(){
    try{
      await saveSelectionsToServer();
      await appendLogsToServer();
    }catch(e){
      log('Errore saveNow: '+(e && e.message || e),'warn');
    }
  }
  function scheduleAutoSave(delayMs = 800){
    if (__saveTimer) return;
    __saveTimer = setTimeout(async ()=>{
      __saveTimer = null;
      await saveSelectionsToServer();
      await appendLogsToServer();
    }, delayMs);
  }
  // ====== END: SAVE COALESCENTE ======

  /* ------- Utils calendario/nomi ------- */
  function selectionsFileName(){ return 'selections_'+state.year+'.txt'; }

  function updateRowCount(tr){
    const inputs=[...tr.querySelectorAll('input')];
    const filled=inputs.reduce((a,i)=>a+(i.value.trim()?1:0),0);
    const total=inputs.length;
    const tdCount=tr.querySelector('.count');
    if(!tdCount) return;
    tdCount.textContent=filled;
    tdCount.className='count '+(filled===total? 'ok' : filled? 'warn':'');
  }

  function isHolidayOrWeekend(d){return [6,0].includes(d.getDay()) || state.holidays.has(fmt(d))}
  function styleToken(val){
    const lo=(val||'').toLowerCase();
    if(val==='TS1')return'ts1';
    if(val==='TS2')return'ts2';
    if(['ferie','par','assente','permesso','malattia','meeting','trasferta'].includes(lo))return'att';
    if(lo==='training')return'training';
    if(val==='REC FERIE')return'rec';
    return'';
  }

  /* ------- Render intestazioni / tabs ------- */
  function updateScrollSnapPadding(){
    const c=document.querySelector('#month'); const thead=document.querySelector('#thead');
    if(!c || !thead) return;
    const h = Math.round(thead.getBoundingClientRect().height) || 0;
    c.style.scrollPaddingTop = h + 'px';
  }
  function buildHeader(){
    updateScrollSnapPadding();
    const names=getColumns();
    const thead = document.getElementById('thead');
    thead.innerHTML='';
    const hr=document.createElement('tr');
    const thD=document.createElement('th'); thD.className='datecol'; thD.textContent='Data'; hr.appendChild(thD);
    names.forEach(n=>{ const th=document.createElement('th'); th.className='name'; th.textContent=n; hr.appendChild(th); });
    const thC=document.createElement('th'); thC.textContent='#'; hr.appendChild(thC);
    thead.appendChild(hr);
  }
  function buildTabs(){
    const tabs=$('#tabs'); tabs.innerHTML='';
    const today=new Date();
    const currentMonth = (today.getFullYear()===state.year) ? (today.getMonth()+1) : 1;
    months.forEach((m,i)=>{
      const monthIndex=i+1;
      const b=document.createElement('button');
      b.className='btn tab'+(monthIndex===currentMonth?' active':'');
      b.textContent=m; b.dataset.m=monthIndex;
      b.onclick=()=>{ renderStack(monthIndex); };
      tabs.appendChild(b);
    });
  }
  function setActiveTab(m){
    [...document.querySelectorAll('#tabs .tab, #tabs .btn')].forEach(b=> b.classList.remove('active'));
    const btn = [...document.querySelectorAll('#tabs .btn')].find(x=>+x.dataset.m===m);
    if(btn) btn.classList.add('active');
  }

  /* ------- Celle / editing ------- */
  function makeCell(date, name){
    const td=document.createElement('td'); td.className='cell'; td.dataset.date=date; td.dataset.name=name; td.dataset.key = `${date},${name}`;
    const input=document.createElement('input'); input.type='text'; input.placeholder=''; input.className='hidden'; input.dataset.date=date; input.dataset.name=name;
    const chip=document.createElement('div'); chip.className='chip hidden'; chip.setAttribute('draggable','true');

    input.addEventListener('keydown', e=>{
      if(e.key==='Enter'){ onCellCommit(input); exitEdit(td,true); }
      else if(e.key==='Escape'){ exitEdit(td,false); }
      else if(['ArrowDown','ArrowUp','ArrowLeft','ArrowRight','Tab'].includes(e.key)){
        suggest.close();
      }
    });
    input.addEventListener('input', ()=>{
      const p=input.dataset.date.split('-'); const d=new Date(+p[2], +p[1]-1, +p[0]);
      styleCell(input,(input.value||'').trim(),d);
      suggest.open(input);
    });

    td.addEventListener('dragover', e=>{ e.preventDefault(); td.classList.add('droptarget'); });
    td.addEventListener('dragleave', ()=> td.classList.remove('droptarget'));
    td.addEventListener('drop', e=>{
      e.preventDefault(); td.classList.remove('droptarget');
      const payload=e.dataTransfer.getData('application/x-planny'); if(!payload) return;
      let data=null; try{data=JSON.parse(payload);}catch(_){}
      if(!data) return;
      const fromKey=data.fromKey, value=data.value, toKey=td.dataset.key;
      if(fromKey===toKey) return;
      const prev=state.selections.get(toKey)||'';
      if(e.shiftKey && prev){
        state.selections.set(fromKey, prev);
        state.selections.set(toKey, value);
        const [fDate,fName] = fromKey.split(',');
        const [tDate,tName] = toKey.split(',');
        logAction('SWAP', fDate, fName, value, `⇄ ${tDate}, ${tName},${prev}`);
        refreshCellByKey(fromKey); refreshCellByKey(toKey);
      }else{
        state.selections.delete(fromKey);
        if(value) state.selections.set(toKey, value);
        const [fDate,fName] = fromKey.split(',');
        const [tDate,tName] = toKey.split(',');
        logAction('MOVE', fDate, fName, value, `→ ${tDate}, ${tName}${prev? ',(overwrite '+prev+')':''}`);
        refreshCellByKey(fromKey); refreshCellByKey(toKey);
      }
      // SOLO debounce (niente saveNow qui)
      scheduleAutoSave();
    });

    chip.addEventListener('dragstart', e=>{
      chip.classList.add('dragging');
      const key=td.dataset.key;
      let value=state.selections.get(key); if(value==null) value=(input.value||'').trim();
      e.dataTransfer.setData('application/x-planny', JSON.stringify({fromKey:key, value}));
      e.dataTransfer.setData('text/plain', value); e.dataTransfer.effectAllowed='move';
    });
    chip.addEventListener('dragend', ()=> chip.classList.remove('dragging'));

    td.appendChild(input); td.appendChild(chip); return td;
  }

  function styleCell(input,val,d){
    input.value = val;
    const td = input.closest('td.cell');
    const chip = td.querySelector('.chip');
    if(td.classList.contains('editing')){ chip.classList.add('hidden'); input.classList.remove('hidden'); return; }
    if(val){
      chip.textContent = val;
      chip.title = val;
      let klass='chip '+styleToken(val);
      if(isHolidayOrWeekend(d)) klass+=' holiday';
      chip.className=klass; chip.classList.remove('hidden'); input.classList.add('hidden');
    }else{
      chip.removeAttribute('title');
      chip.textContent=''; chip.className='chip hidden'; input.classList.remove('hidden');
    }
  }
  function refreshCellByKey(key){
    const td=document.querySelector('td.cell[data-key="'+cssEscape(key)+'"]'); if(!td) return;
    const input=td.querySelector('input'); input.value=state.selections.get(key)||'';
    const p=td.dataset.date.split('-'); const d=new Date(+p[2], +p[1]-1, +p[0]);
    styleCell(input,input.value,d); syncChip(td); updateRowCount(td.closest('tr'));
  }
  function syncChip(td){
    const input=td.querySelector('input'), chip=td.querySelector('.chip');
    const val=(input.value||'').trim();
    if(td.classList.contains('editing')){ chip.classList.add('hidden'); input.classList.remove('hidden'); return; }
    if(val){
      chip.textContent=val;
      chip.title = val;
      let klass='chip '+styleToken(val);
      const parts=td.dataset.date.split('-'); const d=new Date(+parts[2], +parts[1]-1, +parts[0]);
      if(isHolidayOrWeekend(d)) klass+=' holiday';
      chip.className=klass; chip.classList.remove('hidden'); input.classList.add('hidden');
    }else{
      chip.removeAttribute('title');
      chip.textContent=''; chip.className='chip hidden'; input.classList.remove('hidden');
    }
  }

  /* ------- Selezione ed editing ------- */
  function clearSelection(){
    state.selected.forEach(td=>td.classList.remove('selected'));
    state.selected.clear();
  }
  function addToSelection(td){
    if(!td || !td.classList.contains('cell')) return;
    if(!state.selected.has(td)){ state.selected.add(td); td.classList.add('selected'); }
    state.anchorCell = td;
  }
  function toggleSelection(td){
    if(state.selected.has(td)){ td.classList.remove('selected'); state.selected.delete(td); }
    else addToSelection(td);
  }
  function selectionHandleMouse(td, e){
    if(e.shiftKey && state.anchorCell){
      selectRange(state.anchorCell, td);
    }else if(e.ctrlKey || e.metaKey){
      toggleSelection(td);
    }else{
      clearSelection();
      addToSelection(td);
    }
  }
  function selectRange(aTd, bTd){
    if(!aTd || !bTd) return;
    const table = document.getElementById('calendar');
    const aRow = aTd.closest('tr').rowIndex;
    const bRow = bTd.closest('tr').rowIndex;
    const aCol = aTd.cellIndex;
    const bCol = bTd.cellIndex;
    const minR = Math.min(aRow, bRow), maxR = Math.max(aRow, bRow);
    const minC = Math.min(aCol, bCol), maxC = Math.max(aCol, bCol);
    clearSelection();
    for(let r=minR; r<=maxR; r++){
      const row = table.rows[r]; if(!row) continue;
      for(let c=minC; c<=maxC; c++){
        const td = row.cells[c]; if(!td || !td.classList.contains('cell')) continue;
        addToSelection(td);
      }
    }
  }

  function enterEdit(td){
    td.classList.add('editing');
    const input=td.querySelector('input'), chip=td.querySelector('.chip');
    chip.classList.add('hidden'); input.classList.remove('hidden');
    input.dataset.orig=input.value; setTimeout(()=>{input.focus(); input.select(); suggest.open(input);},0);
  }
  function onCellCommit(input){
    const td = input.closest('td.cell');
    const val = (input.value || '').trim();
    writeCell(td, val);
    if(state.search.q) buildSearchHits(state.search.q);
  }
  function exitEdit(td, saveIt){
    const input=td.querySelector('input'); if(!input)return;
    if(saveIt){ onCellCommit(input); } else { input.value=input.dataset.orig||input.value; }
    td.classList.remove('editing');
    syncChip(td);
    if(saveIt){ scheduleAutoSave(); } // solo debounce, niente saveNow
  }

  function writeCell(td, val){
    const key = td.dataset.key;
    const prev = state.selections.get(key) || '';
    if(val){
      state.selections.set(key, val);
      logAction('SET', td.dataset.date, td.dataset.name, val, prev ? `(prev ${prev})` : '');
    }else{
      state.selections.delete(key);
      logAction('DEL', td.dataset.date, td.dataset.name);
    }
    syncChip(td);
    updateRowCount(td.closest('tr'));
  }

  /* ------- Calendario ------- */
  function getColumns(){
    // placeholder: sovrascritto da config
    return state.names && state.names.length ? state.names.slice() : ['Giuseppe','Fabrizio','Paolo','Andrea'];
  }
  function renderStack(monthIndex){
    buildHeader();
    const tbody = document.getElementById('month');
    tbody.innerHTML='';
    const y=state.year;
    const daysInMonth = new Date(y, monthIndex, 0).getDate();
    for(let d=1; d<=daysInMonth; d++){
      const date = pad(d)+'-'+pad(monthIndex)+'-'+y;
      const tr=document.createElement('tr'); tr.dataset.date = date;
      const tdDate=document.createElement('td'); tdDate.className='datecol'; tdDate.textContent=date; tr.appendChild(tdDate);
      getColumns().forEach(name=>{
        const td=makeCell(date, name);
        td.addEventListener('mousedown', e=> selectionHandleMouse(td,e));
        td.addEventListener('dblclick', ()=> enterEdit(td));
        tr.appendChild(td);
      });
      const tdCount=document.createElement('td'); tdCount.className='count'; tr.appendChild(tdCount);
      tbody.appendChild(tr);
      updateRowCount(tr);
    }
  }
  function setMonthAndRender(m){
    renderStack(m);
    setActiveTab(m);
  }

  function jumpToToday(){
    const today=new Date();
    let m = today.getMonth()+1;
    if(today.getFullYear()!==state.year){
      state.year = today.getFullYear();
      const yearInput=$('#year'); if(yearInput) yearInput.value=state.year;
      log('Anno calendario riallineato a quello corrente: '+state.year,'warn');
      loadHolidaysFromLocalOrWeb().then(()=>{
        renderStack(m);
        const tr=document.querySelector('tr[data-date="'+fmt(today)+'"]');
        if(tr){ tr.classList.add('today'); document.querySelector('#month').scrollTo({top: Math.max(0, (tr.offsetTop - (document.querySelector('#thead')?Math.round(document.querySelector('#thead').getBoundingClientRect().height):0))), behavior:'smooth'}); setActiveTab(m); }
      });
      return;
    }
    renderStack(m);
    const tr=document.querySelector('tr[data-date="'+fmt(today)+'"]');
    if(tr){ tr.classList.add('today'); document.querySelector('#month').scrollTo({top: Math.max(0, (tr.offsetTop - (document.querySelector('#thead')?Math.round(document.querySelector('#thead').getBoundingClientRect().height):0))), behavior:'smooth'}); setActiveTab(m); log('Salto a oggi: '+fmt(today),'ok'); }
  }
  function renderAndJumpToToday(){
    const today=new Date(); const sameYear = today.getFullYear()===state.year;
    buildTabs(); renderStack(sameYear?(today.getMonth()+1):1); 
    if(sameYear){
      const tr=document.querySelector('tr[data-date="'+fmt(today)+'"]');
      if(tr){
        tr.classList.add('today');
        const c=document.getElementById('month');
        const head=document.getElementById('thead');
        const headH = head ? Math.round(head.getBoundingClientRect().height) : 0;
        c.scrollTop = Math.max(0, tr.offsetTop - headH - 4);
        setActiveTab(today.getMonth()+1);
      }
    }
  }

  /* ------- Holidays / Config / Selections ------- */
  async function loadHolidaysFromLocalOrWeb(){
    // prima prova file locale festivi_YEAR.txt, altrimenti niente
    const txt = await fetchText(`festivi_${state.year}.txt`);
    state.holidays = new Set();
    if(txt){
      txt.split('\n').map(s=>s.trim()).filter(Boolean).forEach(line=>{
        const t=line.split('#')[0].trim();
        if(/^\d{2}-\d{2}-\d{4}$/.test(t)) state.holidays.add(t);
      });
      log(`Festivi caricati da festivi_${state.year}.txt: ${state.holidays.size} date`,'info');
    }
  }

  function importSelectionsFromText(text){
    const lines = String(text||'').split('\n');
    const map = new Map(); const yearCount = {};
    let n=0;
    lines.forEach(line=>{
      const t=line.trim(); if(!t) return;
      const parts=t.split(','); if(parts.length<3) return;
      const date=parts[0].trim(), name=parts[1].trim(), value=parts.slice(2).join(',').trim();
      const y = parseInt(date.split('-')[2],10); if(!isNaN(y)) yearCount[y]=(yearCount[y]||0)+1;
      const key = `${date},${name}`;
      if(value==='__DEL__' || value==='DEL' || value==='__DELETE__'){
        map.delete(key);
      }else{
        map.set(key, value);
      }
      n++;
    });
    state.selections=map; state.deletions = new Set();
    log(`Selections caricati: ${n} righe`,'ok');
    let yBest=null, cBest=0; for(const y in yearCount){ if(yearCount[y]>cBest){ cBest=yearCount[y]; yBest=parseInt(y,10);} }
    if(yBest && yBest!==state.year){
      state.year = yBest;
      const yearInput=$('#year'); if(yearInput) yearInput.value=state.year;
      log('Anno planner riallineato ai selections: '+state.year,'ok');
      loadHolidaysFromLocalOrWeb().then(()=>{
        const m = (new Date().getFullYear()===state.year)?(new Date().getMonth()+1):1;
        renderStack(m);
      });
    }
  }
  window.importSelectionsFromText = importSelectionsFromText;

  function selectionsToText(){
    const arr=[];
    for(const [k,v] of state.selections.entries()){
      const s = String(v||'').trim();
      arr.push(`${k},${s}`);
    }
    // deletions se previste
    for(const k of (state.deletions||[])) arr.push(`${k},__DEL__`);
    return arr.join('\n')+'\n';
  }

  async function autoLoad(){
    try{
      log('Autoload…','info');
      // config base
      const cfg = (await fetchText('config.txt')) || '';
      // names/options se disponibili in config
      const yearInput=$('#year'); if(yearInput) yearInput.value=state.year;

      await loadHolidaysFromLocalOrWeb();

      const selName = selectionsFileName();
      const selTxt = await getTextFromServer(selName) || await fetchText(selName);
      if(selTxt){ importSelectionsFromText(selTxt); log('Caricato '+selName,'ok'); }
      else {
        let ls=''; try{ ls = localStorage.getItem('selections_'+state.year) || ''; }catch(_){ ls=''; }
        if(ls){ importSelectionsFromText(ls); log('Selections caricati da backup locale (localStorage).','ok'); }
        else { log('Nessun selections trovato: userò '+selName+' per i salvataggi.','warn'); }
      }

      save.selName = selName;
      save.logName = 'planny_log_'+state.year+'.txt';

      try { await appendLogsToServer({force:true}); } catch(e){ log('Impossibile creare/aggiornare il log: '+e.message,'warn'); }

      renderAndJumpToToday();
    }catch(e){
      log('Errore in autoload: '+e.message,'err');
    }
  }

  document.getElementById('jump-today').addEventListener('click', jumpToToday);

  // init
  autoLoad();

  // Ascolto eventi da eventuali selettori anno esterni
  function reconfigureAfterYearChange(){
    const y = state.year;
    const yearInput=$('#year'); if(yearInput) yearInput.value=y;
    loadHolidaysFromLocalOrWeb().then(()=> renderAndJumpToToday());
  }
  try{
    document.addEventListener('planner:reload', reconfigureAfterYearChange);
    window.addEventListener('planner:year-changed', reconfigureAfterYearChange);
  }catch(_){}
})();</script>

<!-- ==== Planny Cloud Year Selector + Cloud Adapter (non-invasivo) ==== -->
<style>
  #cloud-year-box{display:flex;gap:6px;align-items:center;margin:6px 8px}
  #cloud-year-box label{opacity:.8;font-size:12px}
  #cloud-year-box select{padding:4px 8px;border-radius:6px;border:1px solid #c8ced8}
  #cloud-year-badge{font:12px monospace;opacity:.7}
</style>
<script>
(function(){
  const API = '/api/files/';
  const CFG = ['config.ini','config.txt'];
  const bust = () => '?ts=' + Date.now();
  const fname = y => `selections_${String(y).trim()}.txt`;

  async function apiGet(n){
    const r = await fetch(API + encodeURIComponent(n) + bust(), { cache:'no-store' });
    if (r.status === 404) return null;
    if (!r.ok) throw new Error('GET '+n+' → '+r.status);
    return await r.text();
  }
  async function apiPut(n, txt){
    const r = await fetch(API + encodeURIComponent(n), { method:'PUT', body: txt ?? '' });
    if (!r.ok) throw new Error('PUT '+n+' → '+r.status);
    try { return await r.json(); } catch { return { ok:true }; }
  }

  // UI
  const host = document.querySelector('.wrap') || document.body;
  const box = document.createElement('div'); box.id='cloud-year-box';
  box.innerHTML = `
    <label for="cloud-year-select">Anno</label>
    <select id="cloud-year-select"></select>
    <span id="cloud-year-badge"></span>
  `;
  host.insertBefore(box, host.firstChild);

  const sel = box.querySelector('#cloud-year-select');
  const badge = box.querySelector('#cloud-year-badge');

  // anni dinamici (corrente-1 .. corrente+2)
  const now = new Date().getFullYear();
  [now-1, now, now+1, now+2].forEach(y=>{
    const o=document.createElement('option'); o.value=y; o.textContent=y;
    sel.appendChild(o);
  });
  sel.value = String(state.year);

  function setBadge(y){ badge.textContent = `selections_${y}.txt`; }

  sel.addEventListener('change', async ()=>{
    const y = parseInt(sel.value,10)||now;
    if (y===state.year) return;
    state.year = y;
    document.dispatchEvent(new CustomEvent('planner:reload',{detail:{reason:'cloud-year'}}));
    window.dispatchEvent(new CustomEvent('planner:year-changed',{detail:{year:y}}));
    setBadge(y);

    // ricarica selections di quell'anno
    const txt = await apiGet(fname(y));
    if (txt!=null){ importSelectionsFromText(txt); log('[Cloud] Ricaricato '+fname(y),'ok'); }
    else {
      let ls=''; try{ ls = localStorage.getItem('selections_'+y) || ''; }catch(_){ ls=''; }
      importSelectionsFromText(ls||''); log('[Cloud] Nessun file sul server per '+y+' (uso eventuale backup locale).','warn');
    }
  });

  setBadge(state.year);
})();
</script>
</body>
</html>
