<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<title>Planny Web</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<link rel="stylesheet" href="style.css">
</head>
<body>

<div id="header">
  <h1>Planny Web</h1>
</div>

<div id="main">
  <div id="calendar"></div>
</div>

<div id="terminal"></div>

<!-- ==================== PATCHSCRIPT: Gestione anni e salvataggi ==================== -->

<!-- SHIM per year_single_selector.js -->
<script>
(function () {
  const origFetch = window.fetch.bind(window);

  function jsonResponse(obj, status = 200) {
    return new Response(JSON.stringify(obj), {
      status,
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
        'Cache-Control': 'no-store, max-age=0'
      }
    });
  }

  // restituisce [annoCorrente, annoCorrente+1]
  function listYearsFixed() {
    const now = new Date().getFullYear();
    return [now, now + 1];
  }

  async function getSelectionsYear(year) {
    const r1 = await origFetch('/api/files/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (r1.ok) return { ok:true, year, text: await r1.text() };
    const r2 = await origFetch('/api/files/text/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (!r2.ok) return { ok:false, year, text:'' };
    const j = await r2.json().catch(()=>({ ok:false }));
    return (j && j.ok) ? { ok:true, year, text:j.text||'' } : { ok:false, year, text:'' };
  }

  window.fetch = async function (input, init) {
    const url = (typeof input === 'string') ? input : (input?.url || '');
    try {
      if (/\/api\/years(?:\?|$)/.test(url)) {
        return jsonResponse({ ok:true, years: listYearsFixed() });
      }
      const m = /\/api\/selections\/(\d{4})(?:\?|$)/.exec(url);
      if (m) {
        const yr = +m[1];
        const payload = await getSelectionsYear(yr);
        return jsonResponse(payload, payload.ok ? 200 : 404);
      }
    } catch {}
    return origFetch(input, init);
  };
})();
</script>

<!-- Disattiva importer e collega cambio anno -->
<script>
  window.__SINGLE_IMPORTER = "";
  window.addEventListener('planner:year-changed', (ev)=>{
    const y = ev?.detail?.year;
    if (window.state?.year === y) return;
    if (typeof window.reloadSelectionsFromCloud === 'function') {
      window.reloadSelectionsFromCloud(y);
    }
  });
</script>

<!-- Normalizza EOL prima del salvataggio (evita round-trip mismatch) -->
<script>
(function(){
  function normalizeEOL(s){ return (s||'').replace(/\r\n/g, '\n'); }
  const _put = window.putTextToServer;
  if (typeof _put === 'function') {
    window.putTextToServer = function(name, content){
      return _put(name, normalizeEOL(content));
    };
  }
})();
</script>

<!-- Evita doppio debounce se giÃ  esiste scheduleAutoSave -->
<script>
(function(){
  const oSched = window.scheduleAutoSave;
  let t=null;
  window.scheduleAutoSave = function(){
    if (typeof oSched === 'function') return oSched(); // usa la tua versione
    clearTimeout(t);
    t = setTimeout(()=> { if (typeof window.saveNow==='function') window.saveNow(); }, 800);
  };
})();
</script>

<!-- Disabilita eventuale salvataggio festivi se causa errori 500 -->
<script> window.__DISABLE_FESTIVI_SAVE__ = true; </script>

<!-- ==================== FINE PATCHS ==================== -->

<!-- Caricamento logica principale e selettore anno -->
<script src="main.js"></script>
<script src="year_single_selector.js"></script>

</body>
</html>
