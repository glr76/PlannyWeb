<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planny (HTML)</title>
<!-- [qui rimane tutta la tua UI originale: CSS, toolbar, calendario, script esistenti] -->
</head>
<body>

<!-- ======= La tua UI esistente rimane qui invariata ======= -->
<header>
  <h1>Planny (HTML)</h1>
  <!-- il tuo selettore anno già presente nella pagina -->
</header>

<main>
  <!-- il tuo calendario e il tuo terminale -->
  <section id="calendar"></section>
  <section>
    <h2>Terminale</h2>
    <textarea id="terminal" style="width:100%;height:160px;"></textarea>
  </section>
</main>

<!-- … i TUOI script di calendario qui sopra … -->

<!-- === CLOUD PATCH FINALE (UI invariata) === -->
<script>
(function(){
  async function cloudRead(name){
    try{
      const r1 = await fetch('/api/files/text/' + encodeURIComponent(name) + '?' + Date.now(), {cache:'no-store'});
      if (r1.ok) { const j = await r1.json().catch(()=>({ok:false})); if (j && j.ok) return j.text || ''; }
    }catch(_){}
    try{
      const r2 = await fetch('/api/files/' + encodeURIComponent(name) + '?' + Date.now(), {cache:'no-store'});
      if (r2.ok) return await r2.text();
    }catch(_){}
    try{
      const r3 = await fetch(name + '?' + Date.now(), {cache:'no-store'});
      if (r3.ok) return await r3.text();
    }catch(_){}
    return '';
  }
  async function cloudWrite(name, content){
    try{
      const r1 = await fetch('/api/files/text/' + encodeURIComponent(name), {
        method:'PUT', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: content || ''
      });
      const j = await r1.json().catch(()=>({ok:false}));
      if (r1.ok && j && j.ok) return j;
    }catch(_){}
    try{
      const r2 = await fetch('/api/files/' + encodeURIComponent(name), {
        method:'PUT', headers:{'Content-Type':'text/plain; charset=utf-8'}, body: content || ''
      });
      if (r2.ok) { try { return await r2.json(); } catch { return {ok:true}; } }
    }catch(_){}
    throw new Error('Impossibile salvare ' + name);
  }

  // Forza i tuoi helper a usare il cloud
  window.getTextFromServer = async function(name){ return await cloudRead(name); };
  window.putTextToServer  = async function(name, content){ return await cloudWrite(name, content); };

  // Se usi fetchText() in vari punti, forziamo anche quello
  const _origFetchText = (typeof window.fetchText === 'function') ? window.fetchText.bind(window) : null;
  window.fetchText = async function(name){
    const must = /^(config\.ini|config\.txt|selections_\d{4}\.txt|festivi_\d{4}\.txt)$/i.test(name);
    const txt = await cloudRead(name);
    if (txt || must) return txt;
    return _origFetchText ? await _origFetchText(name) : '';
  };

  // Boot robusto: carica selections_<anno>.txt e renderizza non appena pronte le tue funzioni
  function detectYear(){
    if (window.state && window.state.year) return +window.state.year;
    const sel = document.querySelector('#year, #anno, #yearSelect, select[name="year"], select[name="anno"], .year-select, .anno-select');
    if (sel && sel.value) return +sel.value;
    const saved = +localStorage.getItem('plannyYear') || 0;
    const now = new Date().getFullYear();
    return saved || now;
  }
  function waitReady(maxMs=6000){
    return new Promise(res=>{
      const t0=Date.now();
      (function tick(){
        const ok = (typeof window.importSelectionsFromText === 'function') &&
                   (typeof window.renderCalendar === 'function');
        if (ok || Date.now()-t0 > maxMs) return res(!!ok);
        setTimeout(tick, 120);
      })();
    });
  }
  async function loadAndRender(year){
    const name = `selections_${year}.txt`;
    const txt  = await cloudRead(name);
    const ok   = await waitReady();
    if (ok){ window.importSelectionsFromText(txt || ''); window.renderCalendar(); }
    else { console.warn('[Planny] funzioni non pronte; caricato', name, (txt||'').length, 'char'); }
  }
  async function boot(){
    const y = detectYear();
    window.state = window.state || {};
    window.state.year = y;

    // aggancio al tuo selettore anno già esistente (se presente)
    const sel = document.querySelector('#year, #anno, #yearSelect, select[name="year"], select[name="anno"], .year-select, .anno-select');
    if (sel){
      if ([...sel.options].some(o => +o.value === +y)) sel.value = String(y);
      sel.addEventListener('change', async ()=>{
        const v = parseInt(sel.value, 10);
        if (!Number.isNaN(v)) {
          window.state.year = v;
          localStorage.setItem('plannyYear', String(v));
          await loadAndRender(v);
        }
      }, { passive:true });
    }

    await loadAndRender(y);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot);
  else boot();
})();
</script>
<!-- === /CLOUD PATCH FINALE === -->

</body>
</html>
