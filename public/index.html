<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Planny (HTML)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* Stili leggeri: non alterano la tua UI esistente */
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:#111; background:#f7f7f9; }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
    .wrap { max-width:1100px; margin:0 auto; padding:16px 20px; }
    h1 { margin:0; font-size:20px; display:flex; align-items:center; gap:10px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar input[type="number"]{ width:90px; padding:6px 8px; border:1px solid #cfd6df; border-radius:8px; }
    textarea#terminal{ width:100%; height:150px; font-family:ui-monospace,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; }

    /* Spia di salvataggio */
    #save-indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#5b6877;user-select:none}
    #save-indicator .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#aaa}
    #save-indicator .dot.ok{background:#16a34a}      /* verde */
    #save-indicator .dot.dirty{background:#e11d48}   /* rosso */
    #save-indicator .dot.wait{background:#f59e0b;animation:pulse 1.2s infinite ease-in-out} /* giallo */
    @keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <div class="row">
        <h1>
          Planny (HTML)
          <!-- Spia sempre visibile -->
          <span id="save-indicator" title="Stato salvataggio">
            <span class="dot ok"></span><span class="label">salvato</span>
          </span>
        </h1>
        <div class="toolbar">
          <!-- Campo anno semplice (se il tuo year_single_selector inietta da solo la sua UI puoi anche rimuovere questo input) -->
          <label>Anno
            <input id="year" type="number" min="2000" max="2100" step="1" />
          </label>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="calendar" class="card"></section>

    <section class="card" style="margin-top:12px;">
      <h3 style="margin-top:0">Terminale</h3>
      <textarea id="terminal" placeholder="Log azioni…"></textarea>
    </section>
  </main>

  <!-- Dì a year_single_selector qual è l'importer (e opzionale renderer) -->
  <script>window.__SINGLE_IMPORTER = "importSelectionsFromText"; window.__SINGLE_RENDERER = "renderCalendar";</script>

  <!-- Il tuo script esistente -->
  <script src="year_single_selector.js"></script>

  <!-- ====== SHIM FETCH: mappa /api/years e /api/selections/<anno> a endpoint esistenti ====== -->
  <script>
  (function(){
    const origFetch = window.fetch.bind(window);

    function jsonResponse(obj, status=200){
      return new Response(JSON.stringify(obj), {
        status,
        headers: { 'Content-Type':'application/json; charset=utf-8', 'Cache-Control':'no-store, max-age=0' }
      });
    }

    async function listYearsFromBucket(){
      // Usa la lista file e ricava gli anni da selections_YYYY.txt
      try{
        const r = await origFetch('/api/files/list', { cache:'no-store' });
        if (!r.ok) return [];
        const j = await r.json().catch(()=>({}));
        const files = Array.isArray(j.files) ? j.files : [];
        const years = [];
        for (const it of files){
          const name = (it && it.name) ? String(it.name) : '';
          const m = /^selections_(\d{4})\.txt$/i.exec(name);
          if (m) years.push(+m[1]);
        }
        return Array.from(new Set(years)).sort((a,b)=>a-b);
      }catch(_){ return []; }
    }

    async function getSelectionsYear(year){
      // Legge selections_YEAR.txt via endpoint JSON esistente
      const url = '/api/files/text/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now();
      const r = await origFetch(url, { cache:'no-store' });
      if (!r.ok){
        // prova fallback legacy testuale
        const r2 = await origFetch('/api/files/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
        if (!r2.ok) return { ok:false, year, text:'' };
        const text = await r2.text();
        return { ok:true, year, text };
      }
      const j = await r.json().catch(()=>({ok:false, text:''}));
      if (j && j.ok) return { ok:true, year, text: j.text || '' };
      return { ok:false, year, text:'' };
    }

    window.fetch = async function(input, init){
      try{
        const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
        // Intercetta /api/years
        if (/\/api\/years(?:\?|$)/.test(url)){
          const years = await listYearsFromBucket();
          return jsonResponse({ ok:true, years });
        }
        // Intercetta /api/selections/<anno>
        const m = /\/api\/selections\/(\d{4})(?:\?|$)/.exec(url);
        if (m){
          const yr = +m[1];
          const payload = await getSelectionsYear(yr);
          return jsonResponse(payload, payload.ok ? 200 : 404);
        }
      }catch(_){ /* passa sotto al fetch originale */ }
      // Pass-through per tutto il resto
      return origFetch(input, init);
    };
  })();
  </script>

  <!-- ====== I/O CLOUD standard: solo server, nessun download ====== -->
  <script>
  async function getTextFromServer(name){
    const u = '/api/files/text/' + encodeURIComponent(name) + '?' + Date.now();
    try{
      const r = await fetch(u, { cache:'no-store' });
      if (r.ok){
        const j = await r.json().catch(()=>({ok:false}));
        if (j && j.ok) return j.text || '';
      }
    }catch(_){}
    // fallback legacy testuale
    const r2 = await fetch('/api/files/' + encodeURIComponent(name) + '?' + Date.now(), { cache:'no-store' });
    if (r2.ok) return await r2.text();
    return '';
  }

  async function putTextToServer(name, content){
    const r = await fetch('/api/files/text/' + encodeURIComponent(name), {
      method: 'PUT',
      headers: { 'Content-Type': 'text/plain; charset=utf-8' },
      body: content || ''
    });
    const j = await r.json().catch(()=>({ok:false}));
    if (!r.ok || !j.ok) throw new Error('HTTP '+r.status);
    return j;
  }

  // Blocca click che aprirebbero .txt/.ini (niente download)
  (function(){
    const KEY_RX = /(^|\/)(config\.ini|config\.txt|selections_\d{4}\.txt|festivi_\d{4}\.txt)$/i;
    document.addEventListener('click', function(ev){
      const a = ev.target.closest && ev.target.closest('a[href]');
      if(!a) return;
      const href = a.getAttribute('href') || '';
      if (KEY_RX.test(href)) { ev.preventDefault(); ev.stopPropagation(); return false; }
    }, true);
  })();
  </script>

  <!-- ====== Spia + blocco refresh se non salvato + integrazione autosave ====== -->
  <script>
  (function(){
    let __dirty=false, __saving=false, __saveTimer=null;

    function log(msg, level){
      const t = document.getElementById('terminal');
      if (!t) return;
      const tag = level==='warn' ? '[WARN] ' : level==='err' ? '[ERR] ' : '';
      t.value += '\n' + tag + msg;
      t.scrollTop = t.scrollHeight;
    }

    function updateSaveIndicator(){
      const el=document.getElementById('save-indicator'); if(!el) return;
      const dot=el.querySelector('.dot'), lab=el.querySelector('.label');
      if(__saving){ dot.className='dot wait'; lab.textContent='salvataggio…'; return; }
      if(__dirty){ dot.className='dot dirty'; lab.textContent='non salvato'; }
      else{ dot.className='dot ok'; lab.textContent='salvato'; }
    }
    function setDirty(v){ __dirty=!!v; updateSaveIndicator(); }
    function setSaving(v){ __saving=!!v; updateSaveIndicator(); }

    // Blocca refresh/chiusura se non salvato
    window.addEventListener('beforeunload',(e)=>{
      if(__dirty || __saving){ e.preventDefault(); e.returnValue=''; return ''; }
    });

    // Decora writeCell (se esiste) per marcare sporco + autosave
    if(typeof window.writeCell==='function'){
      const __origWriteCell = window.writeCell;
      window.writeCell = function(...args){
        const ret = __origWriteCell.apply(this,args);
        try{ setDirty(true); window.scheduleAutoSave(); }catch(_){}
        return ret;
      };
    }

    // Debounce autosave se non esiste un tuo scheduler
    const __origSchedule = window.scheduleAutoSave;
    window.scheduleAutoSave = function(...args){
      setDirty(true);
      if(typeof __origSchedule==='function'){ return __origSchedule.apply(this,args); }
      clearTimeout(__saveTimer);
      __saveTimer=setTimeout(()=>{ try{ window.saveNow(); }catch(_){ } }, 800);
    };

    // wrap saveNow per mostrare stato e azzerare sporco
    const __origSaveNow = window.saveNow;
    window.saveNow = async function(...args){
      setSaving(true);
      try{
        if(typeof __origSaveNow==='function'){
          const r = await __origSaveNow.apply(this,args);
          setDirty(false);
          return r;
        }else{
          // fallback: salva le selections correnti su server
          if(typeof window.selectionsToText==='function'){
            const y = (window.state && window.state.year) ? window.state.year : (new Date().getFullYear());
            const name = `selections_${y}.txt`;
            const text = window.selectionsToText();
            await window.putTextToServer(name, text);
          }
          setDirty(false);
        }
      }catch(e){
        log('Errore saveNow: '+(e && e.message ? e.message : e), 'warn');
      }finally{
        setSaving(false);
      }
    };

    // esponi per eventuale debug
    window.__saveIndicator={ setDirty, setSaving, updateSaveIndicator };

    // init spia
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', updateSaveIndicator);
    else updateSaveIndicator();
  })();
  </script>

  <!-- ====== Export Excel DISATTIVATO ====== -->
  <script>
    async function exportXLSXServerSave(){ return { ok:true, skipped:true }; }
  </script>

  <!-- ====== Boot: carica selections_<anno>.txt e renderizza con le TUE funzioni ====== -->
  <script>
  (function(){
    function detectYear(){
      if (window.state && window.state.year) return +window.state.year;
      const sel = document.getElementById('year');
      if (sel && sel.value) return +sel.value;
      const saved = +localStorage.getItem('plannyYear') || 0;
      const now = new Date().getFullYear();
      return saved || now;
    }
    async function loadAndRender(year){
      try{
        const txt = await window.getTextFromServer(`selections_${year}.txt`);
        if (typeof window.importSelectionsFromText === 'function') window.importSelectionsFromText(txt||'');
        if (typeof window.renderCalendar === 'function') window.renderCalendar();
      }catch(e){
        const term=document.getElementById('terminal');
        if(term){ term.value += '\n[errore] load '+year+': '+e; term.scrollTop=term.scrollHeight; }
      }
    }
    async function boot(){
      const y = detectYear();
      window.state = window.state || {}; window.state.year = y;

      const sel = document.getElementById('year');
      if (sel) {
        sel.value = String(y);
        sel.addEventListener('change', async ()=> {
          const v = parseInt(sel.value, 10);
          if (!Number.isNaN(v)) {
            window.state.year = v;
            localStorage.setItem('plannyYear', String(v));
            await loadAndRender(v);
          }
        });
      }
      await loadAndRender(y);
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
  })();
  </script>

</body>
</html>
