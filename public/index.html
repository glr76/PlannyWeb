<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planny Cloud</title>
<style>
body{margin:0;font-family:system-ui;background:#f8f9fb;}
header{background:#e9ecf4;padding:8px 12px;border-bottom:1px solid #ccc;display:flex;align-items:center;justify-content:space-between}
#annoSelect{margin-right:10px;}
#statusLight{width:14px;height:14px;border-radius:50%;box-shadow:0 0 4px #0003;transition:background .3s;}
#statusLight.ok{background:#20d420;} #statusLight.saving{background:#ffc400;} #statusLight.error{background:#e33;}
#calendar{width:100%;height:600px;background:#fff;border:1px solid #ccc;margin:10px auto;border-radius:6px;overflow:auto;}
#terminal{width:100%;height:130px;background:#111;color:#0f0;font-family:monospace;overflow-y:auto;border-top:2px solid #333;padding:4px;}
</style>
</head>
<body>
<header>
  <div>
    <label>Anno</label>
    <select id="annoSelect"></select>
  </div>
  <div id="statusLight" class="ok" title="Tutto salvato"></div>
</header>

<div id="calendar">Caricamento calendario...</div>
<textarea id="terminal" readonly>[Terminale pronto]</textarea>

<script>
(function(){
  const term = document.getElementById('terminal');
  const cal = document.getElementById('calendar');
  const sel = document.getElementById('annoSelect');
  const light = document.getElementById('statusLight');
  function log(msg){term.value += "\\n"+msg; term.scrollTop=term.scrollHeight;}
  function setStatus(s,t){light.className=s; if(t)light.title=t; log("["+new Date().toLocaleTimeString()+"] "+t);}

  const API = '/api/files/text/';
  function fname(y){return `selections_${y}.txt`;}

  async function cloudGet(file){
    const r = await fetch(API+encodeURIComponent(file)+'?'+Date.now());
    if(!r.ok)return '';
    const j = await r.json().catch(()=>({}));
    return j.text||'';
  }
  async function cloudPut(file,text){
    setStatus('saving','Salvataggio in corso…');
    const r = await fetch(API+encodeURIComponent(file),{
      method:'PUT',
      headers:{'Content-Type':'text/plain; charset=utf-8'},
      body:text||''
    });
    const j = await r.json().catch(()=>({ok:false}));
    if(!j.ok||!r.ok){setStatus('error','Errore salvataggio');return false;}
    setStatus('ok','Tutto salvato');
    return true;
  }

  window.Cloud={
    async load(y){
      const t=await cloudGet(fname(y));
      if(typeof importSelectionsFromText==='function')importSelectionsFromText(t);
      if(typeof renderCalendar==='function')renderCalendar();
      log(`✔ Caricato ${fname(y)} (${t.length} char)`);
      return t;
    },
    async save(y,text){
      await cloudPut(fname(y),text);
    }
  };

  async function boot(){
    const now=new Date().getFullYear();
    const years=[now-1,now,now+1];
    sel.innerHTML=years.map(y=>`<option>${y}</option>`).join('');
    const saved=localStorage.getItem('plannyYear');
    const y=saved||now;
    sel.value=y;
    window.state={year:y};
    await Cloud.load(y);
  }

  sel.addEventListener('change',async()=>{
    const y=sel.value;
    window.state.year=y;
    localStorage.setItem('plannyYear',y);
    await Cloud.load(y);
  });

  window.addEventListener('beforeunload',(e)=>{
    if(light.classList.contains('saving')){
      e.preventDefault(); e.returnValue='Attendi che il salvataggio termini.';
    }
  });

  document.addEventListener('DOMContentLoaded',boot);
})();
</script>
</body>
</html>
