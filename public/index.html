<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Planny (HTML)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: #f8f9fb;
      color: #222;
    }
    header {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #ddd;
      z-index: 10;
    }
    .topbar {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 16px;
    }
    h1 {
      font-size: 18px;
      margin: 0;
    }
    #save-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #555;
    }
    #save-indicator .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: #ccc;
    }
    #save-indicator .dot.ok { background: #16a34a; }
    #save-indicator .dot.dirty { background: #dc2626; }
    #save-indicator .dot.wait { background: #f59e0b; animation: pulse 1.2s infinite ease-in-out; }
    @keyframes pulse { 0%,100% { opacity:.6 } 50% { opacity:1 } }

    main { padding: 20px; }
    #terminal {
      width: 100%;
      height: 150px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <h1>Planny (HTML)</h1>
    <div id="save-indicator">
      <span class="dot ok"></span>
      <span class="label">salvato</span>
    </div>
    <div id="year-selector" style="margin-left:auto;"></div>
  </div>
</header>

<main>
  <div id="calendar-container"></div>
  <section style="margin-top:20px;">
    <h3>Terminale</h3>
    <textarea id="terminal" placeholder="Log azioni..."></textarea>
  </section>
</main>

<!-- Tutto il tuo codice originale rimane invariato sotto -->

<script src="year_single_selector.js"></script>

<script>
  /* --- PATCH: Gestione spia salvataggio + blocco refresh --- */
  (function(){
    let dirty = false, saving = false, autosaveTimer = null;
    const indicator = document.getElementById('save-indicator');
    const dot = indicator.querySelector('.dot');
    const label = indicator.querySelector('.label');
    const terminal = document.getElementById('terminal');

    function log(msg){
      terminal.value += `\n${msg}`;
      terminal.scrollTop = terminal.scrollHeight;
    }
    function updateIndicator(){
      if(saving){ dot.className='dot wait'; label.textContent='salvataggio...'; return; }
      if(dirty){ dot.className='dot dirty'; label.textContent='non salvato'; }
      else { dot.className='dot ok'; label.textContent='salvato'; }
    }
    function setDirty(v){ dirty = !!v; updateIndicator(); }
    function setSaving(v){ saving = !!v; updateIndicator(); }

    // Blocca refresh se non salvato
    window.addEventListener('beforeunload', e=>{
      if(dirty || saving){ e.preventDefault(); e.returnValue=''; }
    });

    // Intercetta saveNow (se esiste)
    const origSaveNow = window.saveNow;
    window.saveNow = async function(){
      setSaving(true);
      try{
        if(typeof origSaveNow === 'function'){ await origSaveNow(); }
        setDirty(false);
      }catch(e){
        log('[ERRORE salvataggio] ' + e.message);
      }
      setSaving(false);
    };

    // Hook su writeCell per marcare modifiche
    const origWriteCell = window.writeCell;
    if(origWriteCell) {
      window.writeCell = function(...args){
        const r = origWriteCell.apply(this, args);
        setDirty(true);
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=>window.saveNow(), 1000);
        return r;
      };
    }

    updateIndicator();
  })();
</script>

<!-- Rimozione totale export Excel e download -->
<script>
  async function exportXLSXServerSave(){ return { ok:true, skipped:true }; }
</script>

</body>
</html>
