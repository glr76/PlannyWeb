<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Planny (HTML)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      background: #f8f9fb;
      color: #222;
    }
    header {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid #ddd;
      z-index: 10;
    }
    .topbar {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 16px;
    }
    h1 {
      font-size: 18px;
      margin: 0;
    }
    #save-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #555;
    }
    #save-indicator .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      background: #ccc;
    }
    #save-indicator .dot.ok { background: #16a34a; }
    #save-indicator .dot.dirty { background: #dc2626; }
    #save-indicator .dot.wait { background: #f59e0b; animation: pulse 1.2s infinite ease-in-out; }
    @keyframes pulse { 0%,100% { opacity:.6 } 50% { opacity:1 } }

    main { padding: 20px; }
    #terminal {
      width: 100%;
      height: 150px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
    }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <h1>Planny (HTML)</h1>
    <div id="save-indicator">
      <span class="dot ok"></span>
      <span class="label">salvato</span>
    </div>
    <div id="year-selector" style="margin-left:auto;"></div>
  </div>
</header>

<main>
  <div id="calendar-container"></div>
  <section style="margin-top:20px;">
    <h3>Terminale</h3>
    <textarea id="terminal" placeholder="Log azioni..."></textarea>
  </section>
</main>

<!-- ===================================================== -->
<!-- 1️⃣ ADAPTER: collega year_single_selector.js al planner -->
<!-- ===================================================== -->
<script>
  // Nomi che year_single_selector.js si aspetta
  window.__SINGLE_IMPORTER = "plannyImporter";
  window.__SINGLE_RENDERER = "plannyRenderer";

  // Inoltra alle funzioni reali del planner
  function plannyImporter(text) {
    if (typeof window.importSelectionsFromText === 'function') {
      return window.importSelectionsFromText(text);
    }
    if (typeof window.importSelections === 'function') {
      return window.importSelections(text);
    }
    console.warn('[Importer] Manca importSelectionsFromText (o alias).');
  }

  function plannyRenderer() {
    if (typeof window.renderCalendar === 'function') {
      return window.renderCalendar();
    }
    if (typeof window.render === 'function') {
      return window.render();
    }
    console.warn('[Renderer] Manca renderCalendar (o alias).');
  }
</script>

<!-- ==================================================================== -->
<!-- 2️⃣ SHIM ENDPOINT: crea risposte per /api/years e /api/selections/YYYY -->
<!-- ==================================================================== -->
<script>
(function () {
  const origFetch = window.fetch.bind(window);

  function jsonResponse(obj, status = 200) {
    return new Response(JSON.stringify(obj), {
      status,
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
        'Cache-Control': 'no-store, max-age=0'
      }
    });
  }

  async function listYears() {
    try {
      const r = await origFetch('/api/files/list', { cache: 'no-store' });
      if (!r.ok) return [];
      const j = await r.json().catch(() => ({}));
      const files = Array.isArray(j.files) ? j.files : [];
      const years = [];
      for (const it of files) {
        const name = it?.name || '';
        const m = /^selections_(\d{4})\.txt$/i.exec(name);
        if (m) years.push(+m[1]);
      }
      return [...new Set(years)].sort((a, b) => a - b);
    } catch { return []; }
  }

  async function getSelectionsYear(year) {
    const r1 = await origFetch('/api/files/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (r1.ok) return { ok:true, year, text: await r1.text() };

    const r2 = await origFetch('/api/files/text/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (!r2.ok) return { ok:false, year, text:'' };
    const j = await r2.json().catch(()=>({ ok:false }));
    if (j && j.ok) return { ok:true, year, text:j.text || '' };
    return { ok:false, year, text:'' };
  }

  window.fetch = async function (input, init) {
    const url = (typeof input === 'string') ? input : (input?.url || '');
    try {
      if (/\/api\/years(?:\?|$)/.test(url)) {
        const years = await listYears();
        return jsonResponse({ ok: true, years });
      }
      const m = /\/api\/selections\/(\d{4})(?:\?|$)/.exec(url);
      if (m) {
        const yr = +m[1];
        const payload = await getSelectionsYear(yr);
        return jsonResponse(payload, payload.ok ? 200 : 404);
      }
    } catch {}
    return origFetch(input, init);
  };
})();
</script>

<!-- ================================================= -->
<!-- 3️⃣ SELETTORE ANNO - caricato dopo l'adapter/shim -->
<!-- ================================================= -->
<script src="year_single_selector.js"></script>

<!-- ================================================= -->
<!-- 4️⃣ PATCH: spia salvataggio e blocco refresh -->
<!-- ================================================= -->
<script>
  (function(){
    let dirty = false, saving = false, autosaveTimer = null;
    const indicator = document.getElementById('save-indicator');
    const dot = indicator.querySelector('.dot');
    const label = indicator.querySelector('.label');
    const terminal = document.getElementById('terminal');

    function log(msg){
      const t = new Date().toLocaleTimeString();
      terminal.value += `\n[${t}] ${msg}`;
      terminal.scrollTop = terminal.scrollHeight;
    }
    function updateIndicator(){
      if(saving){ dot.className='dot wait'; label.textContent='salvataggio...'; return; }
      if(dirty){ dot.className='dot dirty'; label.textContent='non salvato'; }
      else { dot.className='dot ok'; label.textContent='salvato'; }
    }
    function setDirty(v){ dirty = !!v; updateIndicator(); }
    function setSaving(v){ saving = !!v; updateIndicator(); }

    window.addEventListener('beforeunload', e=>{
      if(dirty || saving){ e.preventDefault(); e.returnValue=''; }
    });

    const origSaveNow = window.saveNow;
    window.saveNow = async function(){
      setSaving(true);
      try{
        if(typeof origSaveNow === 'function'){ await origSaveNow(); }
        setDirty(false);
        log('Salvataggio completato.');
      }catch(e){
        log('ERRORE salvataggio: ' + e.message);
      }
      setSaving(false);
    };

    const origWriteCell = window.writeCell;
    if(origWriteCell) {
      window.writeCell = function(...args){
        const r = origWriteCell.apply(this, args);
        setDirty(true);
        clearTimeout(autosaveTimer);
        autosaveTimer = setTimeout(()=>window.saveNow(), 1000);
        return r;
      };
    }

    updateIndicator();
  })();
</script>

<!-- ================================================= -->
<!-- 5️⃣ Rimozione totale export Excel/download -->
<!-- ================================================= -->
<script>
  async function exportXLSXServerSave(){ return { ok:true, skipped:true }; }
</script>

</body>
</html>
