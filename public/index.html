<!-- ⬇️ QUESTO BLOCCO È AGGIUNTO PRIMA DEL CARICAMENTO DI year_single_selector.js -->
<script>
// --- SHIM per year_single_selector.js: /api/years e /api/selections/YYYY ---
(function () {
  const origFetch = window.fetch.bind(window);

  function jsonResponse(obj, status = 200) {
    return new Response(JSON.stringify(obj), {
      status,
      headers: {
        'Content-Type': 'application/json; charset=utf-8',
        'Cache-Control': 'no-store, max-age=0'
      }
    });
  }

  // NON leggiamo la lista dal server: usiamo anno corrente e anno successivo
  function listYearsFixed() {
    const now = new Date().getFullYear();
    return [now, now + 1];
  }

  async function getSelectionsYear(year) {
    // 1) text/plain
    const r1 = await origFetch('/api/files/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (r1.ok) return { ok:true, year, text: await r1.text() };

    // 2) JSON fallback
    const r2 = await origFetch('/api/files/text/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
    if (!r2.ok) return { ok:false, year, text:'' };
    const j = await r2.json().catch(()=>({ ok:false }));
    if (j && j.ok) return { ok:true, year, text:j.text || '' };
    return { ok:false, year, text:'' };
  }

  // Intercetta solo gli endpoint che usa il selettore
  window.fetch = async function (input, init) {
    const url = (typeof input === 'string') ? input : (input?.url || '');
    try {
      if (/\/api\/years(?:\?|$)/.test(url)) {
        return jsonResponse({ ok:true, years: listYearsFixed() });
      }
      const m = /\/api\/selections\/(\d{4})(?:\?|$)/.exec(url);
      if (m) {
        const yr = +m[1];
        const payload = await getSelectionsYear(yr);
        return jsonResponse(payload, payload.ok ? 200 : 404);
      }
    } catch {}
    return origFetch(input, init);
  };
})();
</script>
<!-- ⬆️ FINE BLOCCO AGGIUNTO -->
