<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Planny (HTML)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:#111; background:#f7f7f9; }
    header { position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
    .wrap { max-width:1100px; margin:0 auto; padding:16px 20px; }
    h1 { margin:0; font-size:20px; display:flex; align-items:center; gap:10px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:12px; }
    textarea#terminal{ width:100%; height:150px; font-family:ui-monospace,Menlo,Consolas,"Liberation Mono",monospace; font-size:12px; }

    /* Spia salvataggio */
    #save-indicator{display:inline-flex;align-items:center;gap:6px;font-size:12px;color:#5b6877;user-select:none}
    #save-indicator .dot{width:10px;height:10px;border-radius:50%;display:inline-block;background:#aaa}
    #save-indicator .dot.ok{background:#16a34a}      /* verde */
    #save-indicator .dot.dirty{background:#e11d48}   /* rosso */
    #save-indicator .dot.wait{background:#f59e0b;animation:pulse 1.2s infinite ease-in-out} /* giallo */
    @keyframes pulse{0%,100%{opacity:.6}50%{opacity:1}}
  </style>
</head>
<body>

  <header>
    <div class="wrap">
      <div class="row">
        <h1>
          Planny (HTML)
          <span id="save-indicator" title="Stato salvataggio">
            <span class="dot ok"></span><span class="label">salvato</span>
          </span>
        </h1>
        <div id="year-selector"></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="calendar" class="card"></section>

    <section class="card" style="margin-top:12px;">
      <h3 style="margin-top:0">Terminale</h3>
      <textarea id="terminal" placeholder="Log azioni…"></textarea>
    </section>
  </main>

  <!-- === ADAPTER GLOBALE per il selettore === -->
  <script>
    // Indica a year_single_selector.js i nomi delle funzioni da usare
    window.__SINGLE_IMPORTER = "plannyImporter";
    window.__SINGLE_RENDERER = "plannyRenderer";

    // Adapter: inoltra alle tue funzioni reali
    function plannyImporter(text) {
      if (typeof window.importSelectionsFromText === 'function') {
        return window.importSelectionsFromText(text);
      }
      if (typeof window.importSelections === 'function') {
        return window.importSelections(text);
      }
      console.warn('[Importer] Nessuna funzione trovata per importare selections.');
    }

    function plannyRenderer() {
      if (typeof window.renderCalendar === 'function') {
        return window.renderCalendar();
      }
      if (typeof window.render === 'function') {
        return window.render();
      }
      console.warn('[Renderer] Nessuna funzione trovata per renderizzare il calendario.');
    }
  </script>

  <!-- Selettore dell’anno -->
  <script src="year_single_selector.js"></script>

  <!-- === SHIM FETCH: /api/years e /api/selections/<anno> === -->
  <script>
  (function(){
    const origFetch = window.fetch.bind(window);
    function jsonResponse(obj, status=200){
      return new Response(JSON.stringify(obj), {
        status,
        headers: { 'Content-Type':'application/json; charset=utf-8', 'Cache-Control':'no-store, max-age=0' }
      });
    }

    async function listYears(){
      try{
        const r = await origFetch('/api/files/list', { cache:'no-store' });
        if (!r.ok) return [];
        const j = await r.json().catch(()=>({}));
        const files = Array.isArray(j.files)?j.files:[];
        const years = [];
        for (const it of files){
          const name = it?.name || '';
          const m = /^selections_(\d{4})\.txt$/i.exec(name);
          if (m) years.push(+m[1]);
        }
        return [...new Set(years)].sort((a,b)=>a-b);
      }catch{ return []; }
    }

    async function getSelectionsYear(year){
      const r1 = await origFetch('/api/files/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
      if (r1.ok) return { ok:true, year, text: await r1.text() };
      const r2 = await origFetch('/api/files/text/' + encodeURIComponent(`selections_${year}.txt`) + '?' + Date.now(), { cache:'no-store' });
      if (!r2.ok) return { ok:false, year, text:'' };
      const j = await r2.json().catch(()=>({ok:false}));
      if (j && j.ok) return { ok:true, year, text:j.text || '' };
      return { ok:false, year, text:'' };
    }

    window.fetch = async function(input, init){
      const url = (typeof input==='string')?input:(input?.url||'');
      try{
        if (/\/api\/years/.test(url)){
          const years = await listYears();
          return jsonResponse({ ok:true, years });
        }
        const m = /\/api\/selections\/(\d{4})/.exec(url);
        if (m){
          const yr = +m[1];
          const payload = await getSelectionsYear(yr);
          return jsonResponse(payload, payload.ok?200:404);
        }
      }catch{}
      return origFetch(input, init);
    };
  })();
  </script>

  <!-- === FUNZIONI CLOUD: lettura/scrittura su Supabase === -->
  <script>
  async function getTextFromServer(name){
    const r1 = await fetch('/api/files/' + encodeURIComponent(name) + '?' + Date.now(), { cache:'no-store' });
    if (r1.ok) return await r1.text();
    const r2 = await fetch('/api/files/text/' + encodeURIComponent(name) + '?' + Date.now(), { cache:'no-store' });
    if (r2.ok){
      const j = await r2.json().catch(()=>({ok:false}));
      if (j && j.ok) return j.text || '';
    }
    return '';
  }

  async function putTextToServer(name, content){
    const r = await fetch('/api/files/text/' + encodeURIComponent(name), {
      method: 'PUT',
      headers: { 'Content-Type': 'text/plain; charset=utf-8' },
      body: content || ''
    });
    const j = await r.json().catch(()=>({ok:false}));
    if (!r.ok || !j.ok) throw new Error('HTTP '+r.status);
    return j;
  }

  // Blocca download accidentali dei .txt/.ini
  document.addEventListener('click', ev=>{
    const a = ev.target.closest?.('a[href]');
    if (!a) return;
    const href = a.getAttribute('href')||'';
    if (/(config|selections|festivi)_\d{4}\.txt$/i.test(href)){ ev.preventDefault(); ev.stopPropagation(); }
  },true);
  </script>

  <!-- === SPIA SALVATAGGIO + BLOCCO REFRESH === -->
  <script>
  (function(){
    let dirty=false, saving=false, timer=null;

    const indicator=document.getElementById('save-indicator');
    const dot=indicator.querySelector('.dot'), label=indicator.querySelector('.label');
    function refresh(){
      if(saving){dot.className='dot wait';label.textContent='salvataggio…';return;}
      if(dirty){dot.className='dot dirty';label.textContent='non salvato';}
      else{dot.className='dot ok';label.textContent='salvato';}
    }
    function setDirty(v){dirty=v;refresh();}
    function setSaving(v){saving=v;refresh();}

    window.addEventListener('beforeunload',e=>{
      if(dirty||saving){e.preventDefault();e.returnValue='';return '';}
    });

    const term=document.getElementById('terminal');
    function log(m){term.value+='\n'+m;term.scrollTop=term.scrollHeight;}

    const origSaveNow=window.saveNow;
    window.saveNow=async function(){
      setSaving(true);
      try{
        if(typeof origSaveNow==='function') await origSaveNow();
        else if(typeof window.selectionsToText==='function'){
          const y=(window.state&&window.state.year)||new Date().getFullYear();
          await putTextToServer(`selections_${y}.txt`,window.selectionsToText());
        }
        setDirty(false);
      }catch(e){log('Errore salvataggio: '+e);}finally{setSaving(false);}
    };

    const origWrite=window.writeCell;
    if(origWrite) window.writeCell=function(...a){const r=origWrite.apply(this,a);setDirty(true);window.scheduleAutoSave?.();return r;}

    const origSched=window.scheduleAutoSave;
    window.scheduleAutoSave=function(){setDirty(true);clearTimeout(timer);timer=setTimeout(()=>window.saveNow(),800);origSched?.();};

    refresh();
  })();
  </script>

  <!-- Export Excel disattivato -->
  <script>async function exportXLSXServerSave(){return{ok:true,skipped:true};}</script>

  <!-- === AVVIO === -->
  <script>
  (function(){
    async function loadAndRender(y){
      const t=await getTextFromServer(`selections_${y}.txt`);
      window.plannyImporter(t||'');
      window.plannyRenderer();
    }
    setTimeout(()=>{if(!window.state?.year)loadAndRender(new Date().getFullYear());},800);
  })();
  </script>

</body>
</html>
